<!doctype html>
<meta charset="utf-8" />
<title>Kindergarten Puzzle (WASM)</title>
<style>
  body {
    margin: 0;
    font-family:
      system-ui,
      Segoe UI,
      Arial;
  }
  #bar {
    display: flex;
    gap: 8px;
    align-items: center;
    padding: 8px;
    border-bottom: 1px solid #ddd;
  }
  #help {
    margin-left: auto;
    color: #666;
  }
  canvas {
    display: block;
    background: #fafafa;
  }
  button,
  input {
    font: inherit;
  }
  #chooser {
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.35);
  }
  #chooser .card {
    background: #fff;
    padding: 20px 24px;
    border-radius: 12px;
    width: 520px;
    box-shadow: 0 12px 32px rgba(0, 0, 0, 0.3);
  }
  #chooser h2 {
    margin: 0 0 12px 0;
    font-weight: 600;
  }
  #chooser ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  #chooser li {
    padding: 8px 0;
    border-bottom: 1px solid #eee;
  }
  #chooser a {
    color: #0a66c2;
    text-decoration: none;
  }
</style>
<div id="bar">
  <button id="homeBtn" style="display: none">Home</button>
  <button id="resetPuzzle">Reset</button>
  <button id="exportPng">Download PNG</button>
  <input type="file" id="file" accept=".json" />
  <button id="tutorBtn">Tutor</button>
  <label for="langSel">Language:</label>
  <select id="langSel">
    <option value="en" selected>English</option>
    <option value="zh">中文</option>
  </select>
  <span id="help">Drag; Q/E rotate (S toggles speed); L restrict; Shift temp restrict; wheel fine-rotate; F mirror</span>
 </div>
<div id="status" style="padding: 6px 12px; color: #444; font-size: 14px; border-bottom: 1px solid #eee; background: #fafafa;">&nbsp;</div>
<canvas
  id="cv"
  width="1200"
  height="800"
  style="
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    border-radius: 12px;
    background: #fff;
  "
></canvas>

<div id="note" style="padding: 8px 12px; color: #333;"></div>

<script type="module">
  // Build wasm to ./pkg then commit it for GitHub Pages
  // wasm-pack build --target web --release --out-dir ./pkg puzzle-wasm
  import init from "./pkg/puzzle_wasm.js";
  init();

  // Toolbar home button: visible only when a puzzle is opened
  const params = new URLSearchParams(location.search);
  const homeBtn = document.getElementById("homeBtn");
  if (homeBtn) {
    if (params.get("p")) {
      homeBtn.style.display = "inline-block";
      homeBtn.addEventListener("click", () => {
        location.href = "./";
      });
    }
  }

  // Tutor overlay (global, same for all puzzles)
  const tutorBtn = document.getElementById("tutorBtn");
  const tutor = document.createElement("div");
  tutor.id = "tutor";
  tutor.style.position = "fixed";
  tutor.style.right = "12px";
  tutor.style.bottom = "12px";
  tutor.style.background = "#fff";
  tutor.style.border = "1px solid #ddd";
  tutor.style.borderRadius = "10px";
  tutor.style.padding = "12px 14px";
  tutor.style.boxShadow = "0 8px 24px rgba(0,0,0,0.2)";
  tutor.style.maxWidth = "420px";
  tutor.style.display = "none";
  document.body.appendChild(tutor);
  const i18n = {
    en: {
      tutorTitle: "Tutor",
      homeBtn: "Home",
      resetBtn: "Reset",
      downloadBtn: "Download PNG",
      tutorBtn: "Tutor",
      langLabel: "Language:",
      home: "Home: Go back to landing",
      reset: "Reset: Restore puzzle to initial state",
      download: "Download PNG: Export blueprint image",
      file: "Load JSON: Open a local puzzle file",
      tutor: "Tutor: Toggle this help panel",
      lang: "Language: Switch English/Chinese",
      help: "Drag; Q/E rotate (S toggles speed); L restrict; Shift temp restrict; wheel fine-rotate; F mirror",
    },
    zh: {
      tutorTitle: "教程",
      homeBtn: "返回主页",
      resetBtn: "重开",
      downloadBtn: "下载 PNG",
      tutorBtn: "教程",
      langLabel: "语言:",
      home: "返回主页：回到站点入口",
      reset: "重开：恢复到初始状态",
      download: "下载 PNG：导出清单图片",
      file: "加载 JSON：打开本地拼图文件",
      tutor: "教程：打开/关闭此帮助面板",
      lang: "语言：切换中英文",
      help: "拖拽；Q/E旋转（S快/慢）；L限制移动；按住Shift临时限制；滚轮微调；F镜像",
    },
  };
  function renderTutor() {
    const lang = document.getElementById("langSel").value;
    const t = i18n[lang] || i18n.en;
    document.getElementById("help").textContent = t.help;
    document.getElementById("homeBtn").textContent = t.homeBtn;
    document.getElementById("resetPuzzle").textContent = t.resetBtn;
    document.getElementById("exportPng").textContent = t.downloadBtn;
    document.getElementById("tutorBtn").textContent = t.tutorBtn;
    const lab = document.querySelector('label[for="langSel"]');
    if (lab) lab.textContent = t.langLabel;
    tutor.innerHTML = `
      <div style="font-weight:600;margin-bottom:6px;">${t.tutorTitle}</div>
      <ul style="margin:0;padding-left:18px;">
        <li>${t.home}</li>
        <li>${t.reset}</li>
        <li>${t.download}</li>
        <li>${t.file}</li>
        <li>${t.tutor}</li>
        <li>${t.lang}</li>
      </ul>
    `;
  }
  tutorBtn?.addEventListener("click", () => {
    renderTutor();
    tutor.style.display = tutor.style.display === "none" ? "block" : "none";
  });
  document.getElementById("langSel")?.addEventListener("change", () => {
    renderTutor();
  });

  // If no query param present, show chooser and populate from puzzles.json
  if (!params.get("p")) {
    const ch = document.getElementById("chooser");
    if (ch) ch.style.display = "flex";
    try {
      const res = await fetch("./puzzles.json");
      if (res.ok) {
        const list = await res.json();
        const ul = document.querySelector("#chooser ul");
        if (Array.isArray(list) && ul) {
          ul.innerHTML = "";
          for (const item of list) {
            const li = document.createElement("li");
            const a = document.createElement("a");
            a.href = `?p=${encodeURIComponent(item.id)}`;
            a.textContent = item.title || item.id;
            li.appendChild(a);
            if (item.desc) {
              const span = document.createElement("span");
              span.textContent = ` — ${item.desc}`;
              span.style.color = "#666";
              span.style.marginLeft = "6px";
              li.appendChild(span);
            }
            ul.appendChild(li);
          }
          // Extra options
          const liFile = document.createElement("li");
          liFile.innerHTML =
            '<a href="#" onclick="document.getElementById(\'file\').click(); return false;">从本地加载 JSON…</a>';
          ul.appendChild(liFile);
          const liDir = document.createElement("li");
          liDir.innerHTML =
            '<a href="puzzle/" target="_blank">Browse puzzle directory</a>';
          ul.appendChild(liDir);
          const liBack = document.createElement("li");
          liBack.innerHTML = '<a href="./">Back to site root</a>';
          ul.appendChild(liBack);
        }
      }
    } catch (e) {
      console.warn("Failed to load puzzles.json", e);
    }
  }
</script>

<div id="chooser">
  <div class="card">
    <h2>Select a Puzzle</h2>
    <ul>
      <li><a href="?p=k11">k11 (example)</a></li>
      <li>
        <a
          href="#"
          onclick="document.getElementById('file').click(); return false;"
          >Load local JSON…</a
        >
      </li>
      <li><a href="puzzle/" target="_blank">Browse puzzle directory</a></li>
      <li><a href="./">Back to site root</a></li>
    </ul>
  </div>
  <script>
    document.addEventListener("change", (e) => {
      if (e.target && e.target.id === "file") {
        document.getElementById("chooser").style.display = "none";
      }
    });
  </script>
</div>
